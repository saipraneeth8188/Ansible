name: Maven build with 5-minute alert

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Maven build with 5-min alert
        run: |
          echo "Starting mvn clean package at $(date)"

          # ---- start watchdog ----
          (
            sleep 300
            echo "ALERT: mvn clean package running more than 5 minutes"
            # Example:
            # curl -X POST -H 'Content-type: application/json' \
            #   --data '{"text":"Maven build running > 5 minutes"}' \
            #   https://hooks.slack.com/services/T000/B000/XXX
          ) &
          WATCHDOG_PID=$!
          # ------------------------

          mvn clean package
          MVN_EXIT_CODE=$?

          # Stop watchdog if mvn finishes early
          kill $WATCHDOG_PID 2>/dev/null

          exit $MVN_EXIT_CODE
